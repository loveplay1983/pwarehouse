{% extends "storage/documents.html" %} 

{% block title %}Faktury{% endblock %}

{% block breadcrumb %}
<script>
function displaymessage(id, name, address, country)
{
	document.getElementById('client_address').innerHTML = '<address><strong>' + name + '</strong><br>' + address + '<br>' + country + '</address><input type="hidden" name="client_id" value="'+ id +'"><button class="btn" data-toggle="modal" href="#add_client">Zmień</button>';
	$('#add_client').modal('hide')
}

function add_item(id, name, sell_price, tax)
{
	add_invoice_item(id, name, sell_price, tax);
	$('#add_item').modal('hide')
}

function add_invoice_item(id, name, sell_price, tax)
{
	var table = document.getElementById('items_to_sell');
	var rowCount = table.rows.length;
	var row = table.insertRow(rowCount);
	var count = document.getElementById('selected_count' + id).value;

	var cell0 = row.insertCell(0);
	cell0.innerHTML = '<td>' + rowCount + '</td>'

	var cell1 = row.insertCell(1);
	cell1.innerHTML = '<td><input type="hidden" name="item_id" value="' + id +'"><input type="hidden" name="item_amount" value="' + count +'">' + name + '</td>'

	var cell2 = row.insertCell(2);
	cell2.innerHTML = '<td>' + count + '</td>'

	var cell3 = row.insertCell(3);
	cell3.innerHTML = '<td>' + sell_price + '</td>'

	var cell4 = row.insertCell(4);
	cell4.innerHTML = '<td><button class="btn" data-toggle="modal"  onclick="remove_invoice_item(' + rowCount + ')">Usuń</button></td>'
}

function add_all_invoice_items()
{
	var table = document.getElementById('all_items');
	var i = 1;
	var rowCount = table.rows.length;
	for (; i <= rowCount; i = i + 1) 
	{
		var id = table.rows[i].cells[0].innerHTML;
		var count = document.getElementById('selected_count' + id).value;
		if (count == 0)
			continue;
		var name = document.getElementById('item_name_' + id).innerHTML
		var sell_price = document.getElementById('item_sell_price_' + id).innerHTML;
		var tax = document.getElementById('item_tax_' + id).innerHTML;
		add_invoice_item(id, name, sell_price, tax);
	}
}

function remove_invoice_item(index)
{
    try
    {
    	var table = document.getElementById('items_to_sell');
    	table.deleteRow(index);
    	var rowCount = table.rows.length;
    	for(var i=1; i<rowCount; i++) 
    	{
            var row = table.rows[i];
            row.cells[0].innerHTML = '<td>' + i + '</td>'
            row.cells[4].innerHTML = '<td><button class="btn" data-toggle="modal"  onclick="remove_invoice_item(' + i + ')">Usun</button></td>'
        }
    }
    catch(e) 
    {
    	alert(e);
    }
}
</script>
<li><a href="/">Hurtownia</a> <span class="divider">/</span></li>
<li><a href="/documents">Dokumenty</a> <span class="divider">/</span></li>
<li><a href="/documents/invoice">Faktury</a> <span class="divider">/</span></li>
<li class="active">Nowa faktura VAT</li>
{% endblock %}

{% block documents_content %}
<form class="form-horizontal">
	<fieldset>
		<legend>Nowa faktura VAT</legend>
		<div class="control-group">
			<label class="control-label" for="input01">Faktura nr</label>
			<div class="controls">
				<div class="input-append">
					<input type="text" class="input-small" style="text-align: right" id="input01">
					<span class="add-on">/2012</span>
				</div>
			</div>
		</div>
		<div class="control-group">
			<label class="control-label" for="input01">Kontrahent</label>
			<div class="controls" id="client_address">
				<button class="btn" data-toggle="modal" href="#add_client">Wybierz</button>
			</div>
		</div>
	</fieldset>
	<button class="btn" data-toggle="modal" href="#add_item">Dodaj towar</button><br><br>
	<table class="table table-condensed" id="items_to_sell">
		<thead>
			<tr>
				<th>#</th>
				<th>Nazwa</th>
				<th>Ilość</th>
				<th>Cena</th>
				<th></th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>
	<input class="btn btn-info" type="submit" value="Zapisz">
</form>
<div id="add_client" class="modal hide" >
	<div class="modal-header">
		<a class="close" data-dismiss="modal">×</a>
		<h3>Kontrahenci</h3>
	</div>
	<div class="modal-body">
		<table class="table">
			<thead>
				<tr>
					<th>#</th>
					<th>Nazwa</th>
					<th>Address</th>
					<th>Kraj</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				{% for item in clients.all %}
				<tr>
					<td>{{ item.id }}</td>
					<td>{{ item.name }}</td>
					<td>{{ item.address }}</td>
					<td>{{ item.country.name }}</td>
					<td>
						<button class="btn btn-small" data-toggle="modal" onclick="displaymessage('{{ item.id }}','{{ item.name}}','{{ item.address }}','{{ item.country.name }}')">Wybierz</button>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<div class="modal-footer">
		<a href="#" class="btn" data-dismiss="modal">Close</a>
	</div>
</div>
<div id="add_item" class="modal hide">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">×</a>
		<h3>Towar</h3>
	</div>
	<div class="modal-body">
		<table class="table" id="all_items">
			<thead>
				<tr>
					<th>Towar</th>
					<th>Kategoria</th>
					<th>Dostępnych</th>
					<th>Wybór</th>
					<th>Cena sprzedaży brutto</th>
					<th>VAT</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				{% for item in items.all %}
				<tr>
					<td style="display:none">{{ item.id }}</td>
					<td><div id="item_name_{{ item.id }}">{{ item.item.name }}</div></td>
					<td><div id="item_category_{{ item.id }}">{{ item.item.category.name }}</div></td>
					<td><div id="item_count{{ item.id }}">{{ item.count }}</div></td>
					<td><input id="selected_count{{ item.id }}" class="span1" type="text"></td>
					<td><div id="item_sell_price_{{ item.id }}">{{ item.sell_price }}</div></td>
					<td><div id="item_tax_{{ item.id }}">{{ item.item.tax_rate }}%</div></td>
					<td>
						<button class="btn btn-small" data-toggle="modal" onclick="javascript:add_item('{{ item.id }}','{{ item.item.name}}', '{{ item.sell_price }}', '{{ item.item.tax_rate }}')">Dodaj</button>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<div class="modal-footer">
		<a onclick="javascript:add_all_invoice_items()" class="btn" data-dismiss="modal">Dodaj wszystkie</a>
	</div>
</div>
{% endblock %}